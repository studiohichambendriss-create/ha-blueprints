blueprint:
  name: Ikea BILRESA scroll wheel (WiZ & Absolute Dimming Fixed)
  description: |
    Ikea BILRESA blueprint met 3 kanalen.
    FIXED: Uses absolute brightness for WiZ compatibility.
    FIXED: Uses state triggers for better scroll detection.
    
    Ensure 'current_switch_position_1-9' sensors are ENABLED on your device.

  domain: automation

  input:
    remote:
      name: Remote
      description: Ikea BILRESA remote control device
      selector:
        device: {}

    channel1_section:
      name: Kanaal 1
      collapsed: true
      input:
        click_action_ch1:
          name: "Kanaal 1: click actie"
          default: []
          selector:
            action: {}
        double_click_action_ch1:
          name: "Kanaal 1: double click actie"
          default: []
          selector:
            action: {}
        long_click_action_ch1:
          name: "Kanaal 1: long press actie"
          default: []
          selector:
            action: {}
        on_hold_action_ch1:
          name: "Kanaal 1: on-hold actie"
          description: Herhaalt totdat losgelaten, zie on_hold_delay
          default: []
          selector:
            action: {}
        scroll_wheel_target_ch1:
          name: "Kanaal 1: scroll target(s)"
          description: Light of media_player die je met het wiel wilt bedienen
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain:
                  - light
                  - media_player
        scroll_wheel_mode_ch1:
          name: "Kanaal 1: scroll mode"
          default: "lights: dim"
          selector:
            select:
              options:
                - "lights: dim"
                - "lights: color temp and color hue"
                - "lights: color temp only"
                - "lights: color hue only"
                - "media: volume control"

    channel2_section:
      name: Kanaal 2
      collapsed: true
      input:
        click_action_ch2:
          name: "Kanaal 2: click actie"
          default: []
          selector:
            action: {}
        double_click_action_ch2:
          name: "Kanaal 2: double click actie"
          default: []
          selector:
            action: {}
        long_click_action_ch2:
          name: "Kanaal 2: long press actie"
          default: []
          selector:
            action: {}
        on_hold_action_ch2:
          name: "Kanaal 2: on-hold actie"
          description: Herhaalt totdat losgelaten, zie on_hold_delay
          default: []
          selector:
            action: {}
        scroll_wheel_target_ch2:
          name: "Kanaal 2: scroll target(s)"
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain:
                  - light
                  - media_player
        scroll_wheel_mode_ch2:
          name: "Kanaal 2: scroll mode"
          default: "lights: dim"
          selector:
            select:
              options:
                - "lights: dim"
                - "lights: color temp and color hue"
                - "lights: color temp only"
                - "lights: color hue only"
                - "media: volume control"

    channel3_section:
      name: Kanaal 3
      collapsed: true
      input:
        click_action_ch3:
          name: "Kanaal 3: click actie"
          default: []
          selector:
            action: {}
        double_click_action_ch3:
          name: "Kanaal 3: double click actie"
          default: []
          selector:
            action: {}
        long_click_action_ch3:
          name: "Kanaal 3: long press actie"
          default: []
          selector:
            action: {}
        on_hold_action_ch3:
          name: "Kanaal 3: on-hold actie"
          description: Herhaalt totdat losgelaten, zie on_hold_delay
          default: []
          selector:
            action: {}
        scroll_wheel_target_ch3:
          name: "Kanaal 3: scroll target(s)"
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain:
                  - light
                  - media_player
        scroll_wheel_mode_ch3:
          name: "Kanaal 3: scroll mode"
          default: "lights: dim"
          selector:
            select:
              options:
                - "lights: dim"
                - "lights: color temp and color hue"
                - "lights: color temp only"
                - "lights: color hue only"
                - "media: volume control"

    global_section:
      name: Globale instellingen
      collapsed: true
      input:
        dim_step_pct:
          name: Dimmer stapgrootte (%)
          default: 5
          selector:
            number:
              mode: box
        dim_min_pct:
          name: Minimum brightness (%)
          default: 5
          selector:
            number:
              mode: box
        min_color_temp:
          name: Minimum kleurtemperatuur (K)
          default: 2200
          selector:
            number:
              mode: box
        max_color_temp:
          name: Maximum kleurtemperatuur (K)
          default: 4000
          selector:
            number:
              mode: box
        color_temp_step:
          name: Kleurtemperatuur stap (K)
          default: 100
          selector:
            number:
              mode: box
        color_hue_step:
          name: Hue stap (graden, 0..360)
          default: 4
          selector:
            number:
              mode: box
        color_saturation:
          name: Saturation (%)
          default: 100
          selector:
            number:
              mode: box
        on_hold_delay:
          name: On-hold delay (sec)
          default: 0.1
          selector:
            number:
              mode: box
              step: 0.1
        volume_step_pct:
          name: Volume stap (%)
          default: 2
          selector:
            number:
              mode: box
        volume_max_pct:
          name: Max volume (%)
          default: 50
          selector:
            number:
              mode: box

alias: Ikea_BILRESA_scroll_wheel
mode: queued
max: 50
max_exceeded: silent

trigger:
  # Press Events
  - platform: state
    entity_id:
      - "{{ var_press_event_ch1 }}"
      - "{{ var_press_event_ch2 }}"
      - "{{ var_press_event_ch3 }}"
    id: press_trigger
  # Scroll Events
  - platform: state
    entity_id:
      - "{{ var_scroll_right_sensor_ch1 }}"
      - "{{ var_scroll_left_sensor_ch1 }}"
      - "{{ var_scroll_right_sensor_ch2 }}"
      - "{{ var_scroll_left_sensor_ch2 }}"
      - "{{ var_scroll_right_sensor_ch3 }}"
      - "{{ var_scroll_left_sensor_ch3 }}"
    id: scroll_trigger

variables:
  targets_entities_ch1: !input scroll_wheel_target_ch1
  targets_entities_ch2: !input scroll_wheel_target_ch2
  targets_entities_ch3: !input scroll_wheel_target_ch3
  scroll_wheel_mode_ch1: !input scroll_wheel_mode_ch1
  scroll_wheel_mode_ch2: !input scroll_wheel_mode_ch2
  scroll_wheel_mode_ch3: !input scroll_wheel_mode_ch3
  var_min_pct: !input dim_min_pct
  var_dim_step_pct: !input dim_step_pct
  var_color_hue_step: !input color_hue_step
  var_color_saturation: !input color_saturation
  var_min_color_temp: !input min_color_temp
  var_max_color_temp: !input max_color_temp
  var_color_temp_step: !input color_temp_step
  var_on_hold_delay: !input on_hold_delay
  var_volume_step_pct: !input volume_step_pct
  var_volume_max_pct: !input volume_max_pct

action:
  - variables:
      t_ent: "{{ trigger.entity_id }}"
      channel: >-
        {% if t_ent in [var_press_event_ch1, var_scroll_left_sensor_ch1, var_scroll_right_sensor_ch1] %}ch1
        {% elif t_ent in [var_press_event_ch2, var_scroll_left_sensor_ch2, var_scroll_right_sensor_ch2] %}ch2
        {% elif t_ent in [var_press_event_ch3, var_scroll_left_sensor_ch3, var_scroll_right_sensor_ch3] %}ch3
        {% else %}unknown{% endif %}
      
      is_press: "{{ trigger.id == 'press_trigger' }}"
      is_scroll: "{{ trigger.id == 'scroll_trigger' }}"
      
      # Rising edge check for scroll (0 to 1)
      pulse_rising: "{{ trigger.from_state.state in ['0','off'] and trigger.to_state.state in ['1','on'] }}"
      
      scroll_dir: >-
        {% if t_ent in [var_scroll_left_sensor_ch1, var_scroll_left_sensor_ch2, var_scroll_left_sensor_ch3] %}left
        {% else %}right{% endif %}

      press_event_type: "{{ trigger.to_state.attributes.event_type | default('') if is_press else '' }}"

  - choose:
      # --- PRESS ACTIONS ---
      - conditions: "{{ is_press }}"
        sequence:
          - choose:
              - conditions: "{{ press_event_type == 'multi_press_1' }}"
                sequence:
                  - choose:
                      - conditions: "{{ channel == 'ch1' }}"
                        sequence: !input click_action_ch1
                      - conditions: "{{ channel == 'ch2' }}"
                        sequence: !input click_action_ch2
                      - conditions: "{{ channel == 'ch3' }}"
                        sequence: !input click_action_ch3
              - conditions: "{{ press_event_type == 'multi_press_2' }}"
                sequence:
                  - choose:
                      - conditions: "{{ channel == 'ch1' }}"
                        sequence: !input double_click_action_ch1
                      - conditions: "{{ channel == 'ch2' }}"
                        sequence: !input double_click_action_ch2
                      - conditions: "{{ channel == 'ch3' }}"
                        sequence: !input double_click_action_ch3
              - conditions: "{{ press_event_type == 'long_press' }}"
                sequence:
                  - choose:
                      - conditions: "{{ channel == 'ch1' }}"
                        sequence:
                          - sequence: !input long_click_action_ch1
                          - repeat:
                              while: "{{ state_attr(var_press_event_ch1, 'event_type') == 'long_press' }}"
                              sequence:
                                - sequence: !input on_hold_action_ch1
                                - delay: "{{ var_on_hold_delay }}"
                      - conditions: "{{ channel == 'ch2' }}"
                        sequence:
                          - sequence: !input long_click_action_ch2
                          - repeat:
                              while: "{{ state_attr(var_press_event_ch2, 'event_type') == 'long_press' }}"
                              sequence:
                                - sequence: !input on_hold_action_ch2
                                - delay: "{{ var_on_hold_delay }}"
                      - conditions: "{{ channel == 'ch3' }}"
                        sequence:
                          - sequence: !input long_click_action_ch3
                          - repeat:
                              while: "{{ state_attr(var_press_event_ch3, 'event_type') == 'long_press' }}"
                              sequence:
                                - sequence: !input on_hold_action_ch3
                                - delay: "{{ var_on_hold_delay }}"

      # --- SCROLL ACTIONS ---
      - conditions: "{{ is_scroll and pulse_rising }}"
        sequence:
          - repeat:
              for_each: "{{ (targets_entities_ch1 if channel == 'ch1' else (targets_entities_ch2 if channel == 'ch2' else targets_entities_ch3)) }}"
              sequence:
                - choose:
                    # lights: dim (Absolute Brightness for WiZ)
                    - conditions:
                        - condition: template
                          value_template: >-
                            {{ (scroll_wheel_mode_ch1 if channel == 'ch1' else (scroll_wheel_mode_ch2 if channel == 'ch2' else scroll_wheel_mode_ch3)) == 'lights: dim' }}
                      sequence:
                        - if:
                            - condition: template
                              value_template: "{{ is_state(repeat.item, 'on') }}"
                          then:
                            - action: light.turn_on
                              target:
                                entity_id: "{{ repeat.item }}"
                              data:
                                brightness: >-
                                  {% set curr = state_attr(repeat.item, 'brightness') | float(0) %}
                                  {% set step = (var_dim_step_pct / 100) * 255 %}
                                  {% if scroll_dir == 'right' %}
                                    {{ [curr + step, 255] | min | int }}
                                  {% else %}
                                    {% set min_bright = (var_min_pct / 100) * 255 %}
                                    {{ [curr - step, min_bright] | max | int }}
                                  {% endif %}
                                transition: 0.1

                    # lights: color temp / hue (Using your existing script helpers)
                    - conditions:
                        - condition: template
                          value_template: >-
                            {% set mode = (scroll_wheel_mode_ch1 if channel == 'ch1' else (scroll_wheel_mode_ch2 if channel == 'ch2' else scroll_wheel_mode_ch3)) %}
                            {{ mode in ['lights: color temp only', 'lights: color temp and color hue'] }}
                      sequence:
                        - action: script.light_color_temp_helper
                          data:
                            mode: "{{ 'down' if scroll_dir == 'left' else 'up' }}"
                            min_color_temp: "{{ var_min_color_temp }}"
                            max_color_temp: "{{ var_max_color_temp }}"
                            color_temp_step: "{{ var_color_temp_step }}"
                            target_light: "{{ repeat.item }}"

                    # media: volume control
                    - conditions:
                        - condition: template
                          value_template: >-
                            {{ (scroll_wheel_mode_ch1 if channel == 'ch1' else (scroll_wheel_mode_ch2 if channel == 'ch2' else scroll_wheel_mode_ch3)) == 'media: volume control' }}
                      sequence:
                        - action: media_player.volume_set
                          target:
                            entity_id: "{{ repeat.item }}"
                          data:
                            volume_level: >-
                              {{ [[
                                  (state_attr(repeat.item, 'volume_level') | float(0)) * 100
                                  + (1 if scroll_dir == 'right' else -1) * var_volume_step_pct,
                                  var_volume_max_pct
                                ] | min, 0] | max / 100 }}

trigger_variables:
  var_remote: !input remote
  # Automatically find entities by regex
  var_press_event_ch1: "{{ device_entities(var_remote) | select('search', 'event\\..+_3$') | first | default('none') }}"
  var_press_event_ch2: "{{ device_entities(var_remote) | select('search', 'event\\..+_6$') | first | default('none') }}"
  var_press_event_ch3: "{{ device_entities(var_remote) | select('search', 'event\\..+_9$') | first | default('none') }}"
  var_scroll_right_sensor_ch1: "{{ device_entities(var_remote) | select('search', 'sensor\\..+switch_position_1$') | first | default('none') }}"
  var_scroll_left_sensor_ch1: "{{ device_entities(var_remote) | select('search', 'sensor\\..+switch_position_2$') | first | default('none') }}"
  var_scroll_right_sensor_ch2: "{{ device_entities(var_remote) | select('search', 'sensor\\..+switch_position_4$') | first | default('none') }}"
  var_scroll_left_sensor_ch2: "{{ device_entities(var_remote) | select('search', 'sensor\\..+switch_position_5$') | first | default('none') }}"
  var_scroll_right_sensor_ch3: "{{ device_entities(var_remote) | select('search', 'sensor\\..+switch_position_7$') | first | default('none') }}"
  var_scroll_left_sensor_ch3: "{{ device_entities(var_remote) | select('search', 'sensor\\..+switch_position_8$') | first | default('none') }}"
